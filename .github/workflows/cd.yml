name: CD

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        id: aws-credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_KEY }}
          aws-region: ap-northeast-2

      - name: Get EC2 deployment parameters from SSM
        uses: dkershner6/aws-ssm-getparameters-action@v2.0.3
        id: ssm
        with:
          parameterPairs: |
            /ci/ec2/host = EC2_HOST,
            /ci/ec2/user = EC2_USER,
            /ci/ec2/private_key = EC2_PRIVATE_KEY,
            /ci/ec2/ssh_port = EC2_SSH_PORT
          withDecryption: "true"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.EC2_PRIVATE_KEY }}
          port: ${{ env.EC2_SSH_PORT }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Create and navigate to project directory
            mkdir -p /home/ubuntu/depromeet
            cd /home/ubuntu/depromeet

            # Initialize git repository if not exists
            if [ ! -d ".git" ]; then
              echo "ğŸ“‹ Initializing git repository..."
              git clone https://github.com/depromeet/17-5-Repo.git .
              echo "âœ… Repository cloned"
            fi

            # (ì„ íƒ) í˜„ì¬ JAR ë°±ì—…
            if [ -f "stock-diary/build/libs/stock-diary-0.0.1-SNAPSHOT.jar" ]; then
              echo "ğŸ“¦ Backing up current JAR..."
              cp stock-diary/build/libs/stock-diary-0.0.1-SNAPSHOT.jar stock-diary-backup-$(date +%Y%m%d_%H%M%S).jar || true
            fi

            # Update code from repository (í˜„ì¬ ì²´í¬ì•„ì›ƒëœ ë¸Œëœì¹˜ ê·¸ëŒ€ë¡œ)
            echo "ğŸ“¥ Pulling latest code for current branch..."
            CUR_BRANCH="$(git rev-parse --abbrev-ref HEAD)" || { echo "âŒ Not a git repo"; exit 1; }
            if [ "$CUR_BRANCH" = "HEAD" ]; then
              echo "âŒ Detached HEAD ìƒíƒœì…ë‹ˆë‹¤. ë¸Œëœì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
              exit 1
            fi
            echo "ğŸ” Current branch: $CUR_BRANCH"
            git fetch --prune origin
            # ë¡œì»¬ ë³€ê²½ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡ fast-forwardë§Œ í—ˆìš©
            git pull --ff-only origin "$CUR_BRANCH" || {
              echo "âŒ Fast-forward ë¶ˆê°€(ë¡œì»¬ ë³€ê²½/ì´ë ¥ ì°¨ì´). ìˆ˜ë™ ì¡°ì¹˜ í•„ìš”."; exit 1;
            }

            # Stop existing application (if running) - skip for now to avoid SSH issues
            echo "â¹ï¸  Checking for existing application..."
            if pgrep -f "stock-diary-0.0.1-SNAPSHOT.jar" > /dev/null; then
              echo "ğŸ“‹ Found running application, will be replaced after build"
            else
              echo "ğŸ“‹ No running application found"
            fi

            # Build the application
            echo "ğŸ”¨ Building application..."
            chmod +x ./gradlew || true
            ./gradlew :stock-diary:build -x test --no-daemon

            # Verify build success
            JAR_PATH="stock-diary/build/libs/stock-diary-0.0.1-SNAPSHOT.jar"
            if [ ! -f "$JAR_PATH" ]; then
              echo "âŒ Build failed - JAR not found at $JAR_PATH"
              exit 1
            fi
            echo "âœ… Build successful - JAR found"
            ls -la stock-diary/build/libs/ || true

            # Start the application
            echo "ğŸš€ Starting new application..."
            [ -f app.log ] && mv app.log "app_$(date +%Y%m%d_%H%M%S).log" || true
            nohup java -jar "$JAR_PATH" > app.log 2>&1 &

            # Wait a moment and check if application started
            sleep 5
            if pgrep -f "stock-diary-0.0.1-SNAPSHOT.jar" > /dev/null; then
              APP_PID="$(pgrep -f "stock-diary-0.0.1-SNAPSHOT.jar" | head -n1 || true)"
              echo "âœ… Application started successfully (pid=$APP_PID)"
              [ -n "$APP_PID" ] && ps -o pid,ppid,etime,cmd -p "$APP_PID" || true
            else
              echo "âŒ Application failed to start"
              echo "ğŸ“‹ Recent logs:"
              tail -100 app.log || true
              exit 1
            fi

            echo "ğŸ‰ Deployment completed successfully!"